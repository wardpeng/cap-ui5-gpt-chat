{"version":3,"file":"Chat.controller.js","names":["BaseController","Helper","Sender","ChatService","Chat","onInit","getRouter","getRoute","attachPatternMatched","onRouteMatched","onAfterRendering","addKeyboardEventsToInput","getView","byId","addEventDelegate","scrollToBottom","event","chat","getParameter","bindElement","path","onDeleteChat","withConfirmation","getInstance","deleteEntity","getBindingContext","navTo","onPostMessage","message","getObject","chatService","binding","getBinding","createEntity","text","trim","model","sender","getModel","getUser","displayName","chat_ID","ID","completion","getCompletion","personality","personality_ID","AI","timeout","behavior","setTimeout","items","getItems","length","getDomRef","scrollIntoView","input","attachBrowserEvent","key","ctrlKey","metaKey","getValue","fireEvent","value","setValue","preventDefault"],"sources":["Chat.controller.ts"],"sourcesContent":["import BaseController from \"./BaseController\";\nimport UI5Event from \"sap/ui/base/Event\";\nimport Helper from \"../util/Helper\";\nimport Context from \"sap/ui/model/odata/v4/Context\";\nimport { IMessages, IChats, Sender } from \"../types/ChatService\";\nimport FeedInput from \"sap/m/FeedInput\";\nimport ODataListBinding from \"sap/ui/model/odata/v4/ODataListBinding\";\nimport UserModel from \"../model/UserModel\";\nimport List from \"sap/m/List\";\nimport ChatService from \"../service/ChatService\";\n\n/**\n * @namespace com.p36.capui5gptchat.controller\n */\nexport default class Chat extends BaseController {\n  public onInit(): void {\n    this.getRouter().getRoute(\"chat\").attachPatternMatched(this.onRouteMatched, this);\n  }\n\n  public onAfterRendering(): void {\n    this.addKeyboardEventsToInput();\n    (<List>this.getView().byId(\"messageList\")).addEventDelegate({\n      onAfterRendering: () => {\n        this.scrollToBottom(100, \"auto\");\n      },\n    });\n  }\n\n  private onRouteMatched(event: UI5Event): void {\n    const { chat } = event.getParameter(\"arguments\");\n    this.getView().bindElement({\n      path: `/Chats(${chat})`,\n    });\n  }\n\n  public onDeleteChat(event: UI5Event): void {\n    Helper.withConfirmation(\"Delete Chat\", \"Are you sure you want to delete this chat?\", async () => {\n      await ChatService.getInstance().deleteEntity(<Context>this.getView().getBindingContext());\n      this.getRouter().navTo(\"home\");\n    });\n  }\n\n  public async onPostMessage(event: UI5Event): Promise<void> {\n    const message = event.getParameter(\"value\");\n    const chat = <IChats>this.getView().getBindingContext().getObject();\n    const chatService = ChatService.getInstance();\n    const binding = <ODataListBinding>this.getView().byId(\"messageList\").getBinding(\"items\");\n\n    await chatService.createEntity<IMessages>(\n      <IMessages>{\n        text: message.trim(),\n        model: chat.model,\n        sender: (<UserModel>this.getModel(\"user\")).getUser().displayName,\n        chat_ID: chat.ID,\n      },\n      binding,\n      false,\n      true\n    );\n\n    const completion = await chatService.getCompletion({\n      chat: chat.ID,\n      model: chat.model,\n      personality: chat.personality_ID,\n    });\n\n    await chatService.createEntity<IMessages>(\n      <IMessages>{\n        text: completion.message,\n        model: chat.model,\n        sender: Sender.AI,\n        chat_ID: chat.ID,\n      },\n      binding,\n      false,\n      true\n    );\n  }\n\n  private scrollToBottom(timeout: number, behavior: ScrollBehavior = \"smooth\"): void {\n    setTimeout(() => {\n      const items = (<List>this.getView().byId(\"messageList\")).getItems();\n      items[items.length - 1].getDomRef().scrollIntoView({ behavior: behavior });\n    }, timeout);\n  }\n\n  private addKeyboardEventsToInput(): void {\n    const input = <FeedInput>this.getView().byId(\"newMessageInput\");\n    input.attachBrowserEvent(\"keydown\", (event: KeyboardEvent) => {\n      if (event.key == \"Enter\" && (event.ctrlKey || event.metaKey) && input.getValue().trim() != \"\") {\n        input.fireEvent(\"post\", { value: input.getValue() });\n        input.setValue(null);\n        event.preventDefault();\n      }\n    });\n  }\n}\n"],"mappings":"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"}